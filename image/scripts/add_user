#!/bin/bash

# Script to add a user with optional VS Code auto-launch configuration
# Based on the add_coder script but more generic

set -e  # Exit on any error

# Default values
USERNAME=""
PASSWORD=""
VSCODE_PORT="8080"
VSCODE_HOST="0.0.0.0"
AUTO_LAUNCH="false"
SUDO_ACCESS="false"
CREATE_DESKTOP_SHORTCUT="false"

# Function to show usage
show_usage() {
    echo "Usage: $0 [OPTIONS]"
    echo ""
    echo "Required Options:"
    echo "  --username USERNAME    Set the username (required)"
    echo "  --password PASSWORD    Set the password (required)"
    echo ""
    echo "Optional Options:"
    echo "  --port PORT           Set VS Code port (default: 8080)"
    echo "  --host HOST           Set VS Code host (default: 0.0.0.0)"
    echo "  --auto-launch         Enable auto-launch of VS Code"
    echo "  --sudo                Grant sudo access to user"
    echo "  --desktop-shortcut    Create desktop shortcut for VS Code"
    echo "  --help                Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0 --username testuser --password 1234"
    echo "  $0 --username developer --password dev123 --sudo --auto-launch"
    echo "  $0 --username admin --password admin123 --sudo --port 9000"
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --username)
            USERNAME="$2"
            shift 2
            ;;
        --password)
            PASSWORD="$2"
            shift 2
            ;;
        --port)
            VSCODE_PORT="$2"
            shift 2
            ;;
        --host)
            VSCODE_HOST="$2"
            shift 2
            ;;
        --auto-launch)
            AUTO_LAUNCH="true"
            shift
            ;;
        --sudo)
            SUDO_ACCESS="true"
            shift
            ;;
        --desktop-shortcut)
            CREATE_DESKTOP_SHORTCUT="true"
            shift
            ;;
        --help|-h)
            show_usage
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo ""
            show_usage
            exit 1
            ;;
    esac
done

# Validate required parameters
if [ -z "$USERNAME" ] || [ -z "$PASSWORD" ]; then
    echo "Error: Username and password are required"
    echo ""
    show_usage
    exit 1
fi

USER_HOME="/home/$USERNAME"

echo "Adding user: $USERNAME"

# Check if user already exists
if id "$USERNAME" &>/dev/null; then
    echo "User $USERNAME already exists, skipping creation."
    exit 0
fi

# Create the user with home directory
useradd -m "$USERNAME"

# Set password
echo "$USERNAME:$PASSWORD" | chpasswd

# Add to sudo group if requested
if [ "$SUDO_ACCESS" = "true" ]; then
    usermod -aG sudo "$USERNAME"
fi

# Create VS Code startup script if auto-launch or desktop shortcut is enabled
if [ "$AUTO_LAUNCH" = "true" ] || [ "$CREATE_DESKTOP_SHORTCUT" = "true" ]; then
    cat > "$USER_HOME/start-vscode.sh" << EOF
#!/bin/bash

# Launch VS Code serve-web for $USERNAME user
echo "Starting VS Code for $USERNAME user..."

# Set display
export DISPLAY=:0

# Start VS Code serve-web in background
code serve-web --port $VSCODE_PORT --host $VSCODE_HOST --without-connection-token &

# Wait a moment for VS Code to start
sleep 3

# Open VS Code in Firefox
firefox http://localhost:$VSCODE_PORT &

echo "VS Code is now running at: http://localhost:$VSCODE_PORT"
echo "Firefox has been launched to open VS Code"
EOF

    # Make the script executable
    chmod +x "$USER_HOME/start-vscode.sh"
fi

# Create desktop entry for auto-launch (only if auto-launch is enabled)
if [ "$AUTO_LAUNCH" = "true" ]; then
    mkdir -p "$USER_HOME/.config/autostart"

    cat > "$USER_HOME/.config/autostart/vscode.desktop" << EOF
[Desktop Entry]
Type=Application
Name=VS Code Auto Launch
Comment=Automatically launch VS Code serve-web
Exec=$USER_HOME/start-vscode.sh
Hidden=false
NoDisplay=false
X-GNOME-Autostart-enabled=true
EOF
fi

# Create desktop shortcut if requested
if [ "$CREATE_DESKTOP_SHORTCUT" = "true" ]; then
    mkdir -p "$USER_HOME/Desktop"

    cat > "$USER_HOME/Desktop/VS-Code.desktop" << EOF
[Desktop Entry]
Version=1.0
Type=Application
Name=VS Code
Comment=Launch VS Code serve-web
Exec=$USER_HOME/start-vscode.sh
Icon=code
Terminal=false
StartupNotify=true
EOF

    # Make desktop shortcut executable
    chmod +x "$USER_HOME/Desktop/VS-Code.desktop"
fi

# Create a basic bashrc with optional VS Code auto-launch
cat > "$USER_HOME/.bashrc" << EOF
# ~/.bashrc: executed by bash(1) for non-login shells.

# If not running interactively, don't do anything
case \$- in
    *i*) ;;
      *) return;;
esac

# Don't put duplicate lines or lines starting with space in the history.
HISTCONTROL=ignoreboth

# Append to the history file, don't overwrite it
shopt -s histappend

# For setting history length see HISTSIZE and HISTFILESIZE in bash(1)
HISTSIZE=1000
HISTFILESIZE=2000

# Check the window size after each command and, if necessary,
# update the values of LINES and COLUMNS.
shopt -s checkwinsize
EOF

# Add VS Code auto-launch to bashrc if enabled
if [ "$AUTO_LAUNCH" = "true" ]; then
    cat >> "$USER_HOME/.bashrc" << EOF

# Auto-launch VS Code on login (only if not already running)
if ! pgrep -f "code serve-web" > /dev/null; then
    echo "Auto-launching VS Code..."
    ~/start-vscode.sh &
fi

# Welcome message
echo "Welcome, $USERNAME! VS Code is configured."
echo "Access VS Code at: http://localhost:$VSCODE_PORT"
EOF
else
    cat >> "$USER_HOME/.bashrc" << EOF

# Auto-launch Firefox with magenticmarket.ai
if ! pgrep -f "firefox.*magenticmarket.ai" > /dev/null; then
    echo "Auto-launching Firefox with magenticmarket.ai..."
    ~/start-firefox.sh &
fi

# Welcome message
echo "Welcome, $USERNAME!"
echo "Firefox opened to: http://magenticmarket.ai"
EOF
fi

# Set ownership of all files
chown -R "$USERNAME:$USERNAME" "$USER_HOME"

# Setup desktop shortcuts
if [ -f "/usr/local/bin/setup-desktop-shortcuts.sh" ]; then
    /usr/local/bin/setup-desktop-shortcuts.sh "$USER_HOME"
    chown -R "$USERNAME:$USERNAME" "$USER_HOME/Desktop"
fi

# Note: Firefox default browser setup is handled by entrypoint.sh after all users are created

# Create Firefox startup script for magenticmarket.ai
cat > "$USER_HOME/start-firefox.sh" << EOF
#!/bin/bash

# Auto-launch Firefox with magenticmarket.ai using persistent profile
echo "Opening Firefox to magenticmarket.ai..."

# Set display
export DISPLAY=:0

# Set Firefox profile directory
FIREFOX_PROFILE_DIR="/home/$USERNAME/firefox-state"
mkdir -p "\$FIREFOX_PROFILE_DIR"

# Start Firefox with persistent profile and magenticmarket.ai
firefox -profile "\$FIREFOX_PROFILE_DIR" http://magenticmarket.ai &

echo "Firefox opened to magenticmarket.ai with persistent profile"
EOF

# Make the script executable
chmod +x "$USER_HOME/start-firefox.sh"

echo "User created successfully!"
echo "Username: $USERNAME"
echo "Password: $PASSWORD"
echo "Sudo Access: $SUDO_ACCESS"
if [ "$AUTO_LAUNCH" = "true" ] || [ "$CREATE_DESKTOP_SHORTCUT" = "true" ]; then
    echo "VS Code Port: $VSCODE_PORT"
    echo "VS Code Host: $VSCODE_HOST"
    echo "VS Code URL: http://localhost:$VSCODE_PORT"
fi
echo "Auto-launch: $AUTO_LAUNCH"
echo "Desktop Shortcut: $CREATE_DESKTOP_SHORTCUT"
echo ""
echo "User configuration:"
if [ "$SUDO_ACCESS" = "true" ]; then
    echo "- Sudo privileges"
fi
if [ "$AUTO_LAUNCH" = "true" ]; then
    echo "- Auto-launch VS Code on login"
fi
if [ "$CREATE_DESKTOP_SHORTCUT" = "true" ]; then
    echo "- Desktop shortcuts for all applications (VS Code, Firefox, Git tools)"
fi
echo "- Firefox set as default browser"
echo "- Firefox auto-opens to http://magenticmarket.ai with persistent profile"
if [ "$AUTO_LAUNCH" = "true" ] || [ "$CREATE_DESKTOP_SHORTCUT" = "true" ]; then
    echo "- VS Code accessible at http://localhost:$VSCODE_PORT"
fi
