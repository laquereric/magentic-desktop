#!/bin/bash

# Script to add a coder user with VS Code auto-launch configuration
# Based on the testuser configuration from Dockerfile

set -e  # Exit on any error

# Default values
USERNAME="coder"
PASSWORD="coder123"
VSCODE_PORT="8080"
VSCODE_HOST="0.0.0.0"
AUTO_LAUNCH_VSCODE="true"
AUTO_LAUNCH_FIREFOX="true"

# Function to show usage
show_usage() {
    echo "Usage: $0 [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  --username USERNAME    Set the username (default: coder)"
    echo "  --password PASSWORD    Set the password (default: coder123)"
    echo "  --port PORT           Set VS Code port (default: 8080)"
    echo "  --host HOST           Set VS Code host (default: 0.0.0.0)"
    echo "  --no-auto-launch      Disable auto-launch of VS Code"
    echo "  --no-auto-launch-firefox Disable auto-launch of Firefox (default: enabled)"
    echo "  --help                Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0 --username developer --password dev123"
    echo "  $0 --port 9000 --no-auto-launch"
    echo "  $0 --username admin --password admin123 --port 8080"
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --username)
            USERNAME="$2"
            shift 2
            ;;
        --password)
            PASSWORD="$2"
            shift 2
            ;;
        --port)
            VSCODE_PORT="$2"
            shift 2
            ;;
        --host)
            VSCODE_HOST="$2"
            shift 2
            ;;
        --no-auto-launch)
            AUTO_LAUNCH_VSCODE="true"
            shift
            ;;
        --no-auto-launch-firefox)
            AUTO_LAUNCH_FIREFOX="true"
            shift
            ;;
        --help|-h)
            show_usage
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo ""
            show_usage
            exit 1
            ;;
    esac
done

USER_HOME="/home/$USERNAME"

echo "Adding coder user with VS Code auto-launch configuration..."

# Create the user with home directory
useradd -m "$USERNAME"

# Set password
echo "$USERNAME:$PASSWORD" | chpasswd

# Add to sudo group
usermod -aG sudo "$USERNAME"

# Configure applications (VSCode and Firefox)
echo "Configuring applications for user $USERNAME..."

# Detect the correct display
DISPLAY_NUM=$(/usr/local/bin/get_display)
echo "Using display: $DISPLAY_NUM"

/usr/local/bin/config_apps --username "$USERNAME" --port "$VSCODE_PORT" --host "$VSCODE_HOST" --display "$DISPLAY_NUM" \
    $([ "$AUTO_LAUNCH_VSCODE" = "true" ] && echo "--auto-launch-vscode") \
    $([ "$AUTO_LAUNCH_FIREFOX" = "true" ] && echo "--auto-launch-firefox") \
    --desktop-shortcuts

# Set proper ownership (verify user exists first)
if id "$USERNAME" &>/dev/null; then
    chown -R "$USERNAME:$USERNAME" "$USER_HOME"
else
    echo "Error: User $USERNAME was not created properly"
    exit 1
fi

# Setup desktop shortcuts
if [ -f "/usr/local/bin/setup-desktop-shortcuts.sh" ]; then
    /usr/local/bin/setup-desktop-shortcuts.sh "$USER_HOME"
    if id "$USERNAME" &>/dev/null; then
        chown -R "$USERNAME:$USERNAME" "$USER_HOME/Desktop"
    else
        echo "Error: User $USERNAME does not exist when setting desktop ownership"
        exit 1
    fi
fi

# Note: Firefox default browser setup is handled by entrypoint.sh after all users are created
# Application configuration is now handled by config_apps script

# Create a basic bashrc (VS Code and Firefox auto-launch are handled by their respective scripts)
cat > "$USER_HOME/.bashrc" << 'EOF'
# ~/.bashrc: executed by bash(1) for non-login shells.

# If not running interactively, don't do anything
case $- in
    *i*) ;;
      *) return;;
esac

# Don't put duplicate lines or lines starting with space in the history.
HISTCONTROL=ignoreboth

# Append to the history file, don't overwrite it
shopt -s histappend

# For setting history length see HISTSIZE and HISTFILESIZE in bash(1)
HISTSIZE=1000
HISTFILESIZE=2000

# Check the window size after each command and, if necessary,
# update the values of LINES and COLUMNS.
shopt -s checkwinsize

# Welcome message
echo "Welcome, $USERNAME!"
EOF

# Set ownership of .bashrc
if id "$USERNAME" &>/dev/null; then
    chown "$USERNAME:$USERNAME" "$USER_HOME/.bashrc"
else
    echo "Error: User $USERNAME does not exist when setting .bashrc ownership"
    exit 1
fi

echo "User created successfully!"
echo "Username: $USERNAME"
echo "Password: $PASSWORD"
echo "VS Code Port: $VSCODE_PORT"
echo "VS Code Host: $VSCODE_HOST"
echo "Auto-launch VS Code: $AUTO_LAUNCH_VSCODE"
echo "Auto-launch Firefox: $AUTO_LAUNCH_FIREFOX"
echo "VS Code URL: http://localhost:$VSCODE_PORT"
echo ""
echo "User configuration:"
if [ "$AUTO_LAUNCH_VSCODE" = "true" ]; then
    echo "- Auto-launch VS Code on login"
fi
if [ "$AUTO_LAUNCH_FIREFOX" = "true" ]; then
    echo "- Auto-launch Firefox on login"
fi
echo "- Desktop shortcuts for all applications (VS Code, Firefox, Git tools)"
echo "- Firefox set as default browser"
echo "- VS Code opens with two tabs in Firefox using persistent profile"
echo "- Sudo privileges"
echo "- VS Code accessible at http://localhost:$VSCODE_PORT"
