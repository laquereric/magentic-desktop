#!/bin/bash

# Script to create user directories for persistent profiles and data
# This script creates necessary directories for users to store persistent data

set -e  # Exit on any error

echo "Creating user directories for persistent profiles..."

# Function to show usage
show_usage() {
    echo "Usage: $0 [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  --user USERNAME     Create directories for specific user"
    echo "  --all               Create directories for all default users"
    echo "  --help              Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0 --user testuser  # Create directories for testuser"
    echo "  $0 --all            # Create directories for all users"
    echo ""
    echo "Default users: testuser, coder"
}

# Default values
TARGET_USER=""
CREATE_ALL="false"

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --user)
            TARGET_USER="$2"
            shift 2
            ;;
        --all)
            CREATE_ALL="true"
            shift
            ;;
        --help|-h)
            show_usage
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            show_usage
            exit 1
            ;;
    esac
done

# Function to create directories for a user
create_user_dirs() {
    local username="$1"
    local user_home="/home/$username"
    
    echo "Creating directories for user: $username"
    
    # Create user home directory if it doesn't exist
    if [ ! -d "$user_home" ]; then
        echo "Warning: User home directory $user_home does not exist"
        return 1
    fi
    
    # Create Firefox state directory
    local firefox_dir="$user_home/firefox-state"
    mkdir -p "$firefox_dir"
    chmod 755 "$firefox_dir"
    chown "$username:$username" "$firefox_dir" 2>/dev/null || true
    
    # Create VS Code workspace directory
    local vscode_dir="$user_home/vscode-workspace"
    mkdir -p "$vscode_dir"
    chmod 755 "$vscode_dir"
    chown "$username:$username" "$vscode_dir" 2>/dev/null || true
    
    # Create desktop directory if it doesn't exist
    local desktop_dir="$user_home/Desktop"
    mkdir -p "$desktop_dir"
    chmod 755 "$desktop_dir"
    chown "$username:$username" "$desktop_dir" 2>/dev/null || true
    
    # Create documents directory if it doesn't exist
    local docs_dir="$user_home/Documents"
    mkdir -p "$docs_dir"
    chmod 755 "$docs_dir"
    chown "$username:$username" "$docs_dir" 2>/dev/null || true
    
    # Create downloads directory if it doesn't exist
    local downloads_dir="$user_home/Downloads"
    mkdir -p "$downloads_dir"
    chmod 755 "$downloads_dir"
    chown "$username:$username" "$downloads_dir" 2>/dev/null || true
    
    echo "âœ“ Created directories for $username:"
    echo "  - Firefox state: $firefox_dir"
    echo "  - VS Code workspace: $vscode_dir"
    echo "  - Desktop: $desktop_dir"
    echo "  - Documents: $docs_dir"
    echo "  - Downloads: $downloads_dir"
}

# Main execution
if [ "$CREATE_ALL" = "true" ]; then
    echo "Creating directories for all default users..."
    create_user_dirs "testuser"
    create_user_dirs "coder"
    echo "All user directories created successfully!"
elif [ -n "$TARGET_USER" ]; then
    create_user_dirs "$TARGET_USER"
    echo "User directories created successfully!"
else
    echo "Error: Must specify either --user USERNAME or --all"
    echo ""
    show_usage
    exit 1
fi
