#!/bin/bash

# Script to fix Mac keyboard issues in Linux desktop environment
# This script installs and configures Mac keyboard support

set -e  # Exit on any error

echo "Fixing Mac keyboard issues..."

# Update package lists
apt-get update

# Install additional keyboard packages
apt-get install -y \
    xserver-xorg-input-all \
    xserver-xorg-input-libinput \
    xserver-xorg-input-evdev \
    xserver-xorg-input-synaptics \
    xkeyboard-config \
    console-setup \
    keyboard-configuration

# Create Mac keyboard configuration
cat > /etc/X11/xorg.conf.d/90-mac-keyboard.conf << 'EOF'
Section "InputClass"
    Identifier "Mac Keyboard"
    MatchIsKeyboard "on"
    MatchProduct "Apple"
    Option "XkbLayout" "us"
    Option "XkbVariant" "mac"
    Option "XkbOptions" "altwin:swap_lalt_lwin"
EndSection

Section "InputClass"
    Identifier "Generic Keyboard"
    MatchIsKeyboard "on"
    Option "XkbLayout" "us"
    Option "XkbVariant" "mac"
    Option "XkbOptions" "altwin:swap_lalt_lwin"
EndSection
EOF

# Set default keyboard layout for all users
cat > /etc/default/keyboard << 'EOF'
XKBMODEL="pc105"
XKBLAYOUT="us"
XKBVARIANT="mac"
XKBOPTIONS="altwin:swap_lalt_lwin"
BACKSPACE="guess"
EOF

# Configure keyboard for current session
if [ -n "$DISPLAY" ]; then
    setxkbmap -layout us -variant mac -option altwin:swap_lalt_lwin
    echo "Keyboard layout set for current session"
fi

# Create a user script to fix keyboard on login
cat > /usr/local/bin/fix-keyboard.sh << 'EOF'
#!/bin/bash
# Fix keyboard layout for Mac users
if [ -n "$DISPLAY" ]; then
    setxkbmap -layout us -variant mac -option altwin:swap_lalt_lwin
fi
EOF

chmod +x /usr/local/bin/fix-keyboard.sh

# Add keyboard fix to autostart
mkdir -p /etc/xdg/autostart
cat > /etc/xdg/autostart/fix-keyboard.desktop << 'EOF'
[Desktop Entry]
Type=Application
Name=Fix Mac Keyboard
Comment=Fix Mac keyboard layout
Exec=/usr/local/bin/fix-keyboard.sh
Hidden=false
NoDisplay=false
X-GNOME-Autostart-enabled=true
EOF

echo "Mac keyboard support installed and configured!"
echo ""
echo "To apply changes immediately:"
echo "1. Restart the desktop environment"
echo "2. Or run: setxkbmap -layout us -variant mac -option altwin:swap_lalt_lwin"
echo "3. Or log out and log back in"
echo ""
echo "The keyboard layout will be automatically set on future logins."
